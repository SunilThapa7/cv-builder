{% extends 'base.html' %}

{% block title %}Edit CV{% endblock %}

{% block content %}
<div class="form-container">
    <h1>Edit CV: {{ cv.title }}</h1>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-section">
            <h2>Basic Information</h2>
            {{ form.title.errors }}
            <label>CV Title *</label>
            {{ form.title }}
            
            {{ form.template.errors }}
            <label>Template *</label>
            {{ form.template }}
        </div>
        
        <div class="form-section">
            <h2>Personal Information</h2>
            {{ form.full_name.errors }}
            <label>Full Name *</label>
            {{ form.full_name }}
            
            {{ form.job_title.errors }}
            <label>Job Title</label>
            {{ form.job_title }}
            
            {{ form.email.errors }}
            <label>Email *</label>
            {{ form.email }}
            
            {{ form.phone.errors }}
            <label>Phone</label>
            {{ form.phone }}
            
            {{ form.location.errors }}
            <label>Location</label>
            {{ form.location }}
            
            {{ form.links.errors }}
            <label>Links (LinkedIn, GitHub, etc.)</label>
            {{ form.links }}
            {% if is_advanced_template %}
            {{ form.photo.errors }}
            <label>Photo (optional)</label>
            {{ form.photo }}
            {% endif %}
        </div>
        
        <div class="form-section">
            <h2>Summary</h2>
            {{ form.summary.errors }}
            <label>Professional Summary</label>
            {{ form.summary }}
        </div>
        
        <div class="form-section">
            <h2>Skills</h2>
            {{ form.skills.errors }}
            <label>Skills (comma-separated)</label>
            {{ form.skills }}
        </div>
        
        <div class="form-section">
            <h2>Experience</h2>
            {{ exp_formset.management_form }}
            <div id="exp-forms">
                {% for f in exp_formset %}
                <div class="formset-item">
                    {{ f.non_field_errors }}
                    <label>Company</label>{{ f.company }}
                    <label>Role / Position</label>{{ f.position }}
                    <label>Duration</label>{{ f.duration }}
                    <label>Website</label>{{ f.website }}
                    <label>Responsibilities</label>{{ f.responsibilities }}
                    <label>Description</label>{{ f.description }}
                    {% if exp_formset.can_delete %}
                    <span style="display:none;">{{ f.DELETE }}</span>
                    <button type="button" class="btn btn-link text-danger remove-item" data-prefix="exp">Remove</button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-secondary" id="add-exp">Add Experience</button>
        </div>
        <script>
        (function(){
          const prefix = 'exp';
          const container = document.getElementById('exp-forms');
          const addBtn = document.getElementById('add-exp');
          const totalEl = document.querySelector('input[name="' + prefix + '-TOTAL_FORMS"]');
          const emptyHtml = `{{ exp_formset.empty_form.as_p|escapejs }}`;

          // Delegate remove clicks: check DELETE and hide row
          container.addEventListener('click', function(e){
            if(e.target && e.target.classList.contains('remove-item')){
              const item = e.target.closest('.formset-item');
              if(!item) return;
              const delField = item.querySelector('input[type="checkbox"][name^="' + prefix + '-"][name$="-DELETE"]');
              if(delField){ delField.checked = true; }
              item.style.display = 'none';
            }
          });

          addBtn.addEventListener('click', function(){
            const idx = parseInt(totalEl.value, 10);
            const html = emptyHtml.replace(/__prefix__/g, idx);
            const wrapper = document.createElement('div');
            wrapper.className = 'formset-item';
            wrapper.innerHTML = html;
            // hide raw DELETE checkbox if present
            const delLabel = wrapper.querySelector('input[name$="-DELETE"]');
            if(delLabel){ delLabel.parentElement && (delLabel.parentElement.style.display = 'none'); }
            // add remove button
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-link text-danger remove-item';
            btn.dataset.prefix = prefix;
            btn.textContent = 'Remove';
            wrapper.appendChild(btn);

            container.appendChild(wrapper);
            totalEl.value = idx + 1;
          });
        })();
        </script>
        
        <div class="form-section">
            <h2>Education</h2>
            {{ edu_formset.management_form }}
            <div id="edu-forms">
                {% for f in edu_formset %}
                <div class="formset-item">
                    {{ f.non_field_errors }}
                    <label>Institution</label>{{ f.institution }}
                    <label>Degree</label>{{ f.degree }}
                    <label>Duration</label>{{ f.duration }}
                    <label>Status</label>{{ f.status }}
                    {% if edu_formset.can_delete %}
                    <span style="display:none;">{{ f.DELETE }}</span>
                    <button type="button" class="btn btn-link text-danger remove-item" data-prefix="edu">Remove</button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-secondary" id="add-edu">Add Education</button>
        </div>
        <script>
        (function(){
          const prefix = 'edu';
          const container = document.getElementById('edu-forms');
          const addBtn = document.getElementById('add-edu');
          const totalEl = document.querySelector('input[name="' + prefix + '-TOTAL_FORMS"]');
          const emptyHtml = `{{ edu_formset.empty_form.as_p|escapejs }}`;

          container.addEventListener('click', function(e){
            if(e.target && e.target.classList.contains('remove-item')){
              const item = e.target.closest('.formset-item');
              if(!item) return;
              const delField = item.querySelector('input[type="checkbox"][name^="' + prefix + '-"][name$="-DELETE"]');
              if(delField){ delField.checked = true; }
              item.style.display = 'none';
            }
          });

          addBtn.addEventListener('click', function(){
            const idx = parseInt(totalEl.value, 10);
            const html = emptyHtml.replace(/__prefix__/g, idx);
            const wrapper = document.createElement('div');
            wrapper.className = 'formset-item';
            wrapper.innerHTML = html;
            const delLabel = wrapper.querySelector('input[name$="-DELETE"]');
            if(delLabel){ delLabel.parentElement && (delLabel.parentElement.style.display = 'none'); }
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-link text-danger remove-item';
            btn.dataset.prefix = prefix;
            btn.textContent = 'Remove';
            wrapper.appendChild(btn);

            container.appendChild(wrapper);
            totalEl.value = idx + 1;
          });
        })();
        </script>
        
        <div class="form-section">
            <h2>Projects</h2>
            {{ proj_formset.management_form }}
            <div id="proj-forms">
                {% for f in proj_formset %}
                <div class="formset-item">
                    {{ f.non_field_errors }}
                    <label>Name</label>{{ f.name }}
                    <label>Description</label>{{ f.description }}
                    <label>Technologies</label>{{ f.technologies }}
                    <label>Status</label>{{ f.status }}
                    {% if proj_formset.can_delete %}
                    <span style="display:none;">{{ f.DELETE }}</span>
                    <button type="button" class="btn btn-link text-danger remove-item" data-prefix="proj">Remove</button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-secondary" id="add-proj">Add Project</button>
        </div>
        <script>
        (function(){
          const prefix = 'proj';
          const container = document.getElementById('proj-forms');
          const addBtn = document.getElementById('add-proj');
          const totalEl = document.querySelector('input[name="' + prefix + '-TOTAL_FORMS"]');
          const emptyHtml = `{{ proj_formset.empty_form.as_p|escapejs }}`;

          container.addEventListener('click', function(e){
            if(e.target && e.target.classList.contains('remove-item')){
              const item = e.target.closest('.formset-item');
              if(!item) return;
              const delField = item.querySelector('input[type="checkbox"][name^="' + prefix + '-"][name$="-DELETE"]');
              if(delField){ delField.checked = true; }
              item.style.display = 'none';
            }
          });

          addBtn.addEventListener('click', function(){
            const idx = parseInt(totalEl.value, 10);
            const html = emptyHtml.replace(/__prefix__/g, idx);
            const wrapper = document.createElement('div');
            wrapper.className = 'formset-item';
            wrapper.innerHTML = html;
            const delLabel = wrapper.querySelector('input[name$="-DELETE"]');
            if(delLabel){ delLabel.parentElement && (delLabel.parentElement.style.display = 'none'); }
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-link text-danger remove-item';
            btn.dataset.prefix = prefix;
            btn.textContent = 'Remove';
            wrapper.appendChild(btn);

            container.appendChild(wrapper);
            totalEl.value = idx + 1;
          });
        })();
        </script>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}
